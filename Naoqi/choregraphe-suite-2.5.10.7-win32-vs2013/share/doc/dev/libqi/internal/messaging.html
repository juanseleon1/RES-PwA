<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Messaging system &mdash; Aldebaran 2.5.9.8-r3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.5.9.8-r3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Aldebaran 2.5.9.8-r3 documentation" href="../../../index.html" />
    <link rel="up" title="qi Framework" href="../index.html" />
    <link rel="next" title="qi Framework - ChangeLog" href="../changelog/index.html" />
    <link rel="prev" title="Call code path" href="call.html" />
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115894784-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115894784-1');
</script>

<script type="text/javascript" src="https://cloud.aldebaran-robotics.com/static/js/topbar.js"></script>
<style>
div#hd::after {
  
  
  content: 'NAOqi 2.5';
  
  
  
  position: absolute;
  margin-top: -54px;
  right: -4px;
  font-size: 125%;
  -webkit-transform: rotate(45deg);
  -moz-transform: rotate(45deg);
  -o-transform: rotate(45deg);
  transform: rotate(45deg);
  }
</style>
<script>

$(window).ready(function () {

    //Aldebaran Top bar
     var barLinks = [];
     barLinks.push({'name':'Aldebaran Site', 'url':'http://www.aldebaran-robotics.com', 'click':'', 'img':'https://cloud.aldebaran-robotics.com/static/img/aldeb.png'});
     barLinks.push({'name':'Documentation', 'url':'../../../index.html', 'click':"", 'img':''});
     function ShowBar(name, email, usertype) {
        var barParams = {
            'name'    : name,
            'email'   : email,
            'usertype': usertype,
            'loginfct': "FctLogin"
        }
        try { InitTopBar(barParams, barLinks); } catch (e) { console.log('Top Bar Init Failed'); }
    }
    ShowBar();

    var width_label = 0;
    $('dl.function-index dt > span').each(function () {
        $(this).css('width', 'auto');
        width_label = Math.max(width_label, $(this).width());
    }).width(width_label + 30);
    $('.sig-paren').width('auto');

    // first level navigation

    var buttonIds = [".naoqi", "pepper", "nao", "romeo"];
    for(id in buttonIds){
        $(id).removeClass("active");
    }
    //Aldebaran project
    if ($('.toctree-l1.current a').text().indexOf("Romeo ")==0){
        $(".romeo").toggleClass('active');
    }
    else if ($('.toctree-l1.current a').text().indexOf("Pepper ")==0){
        $(".pepper").toggleClass('active');
    }
    else if ($('.toctree-l1.current a').text().indexOf("NAO ")==0){
        $(".nao").toggleClass('active');
    }
    else if($('.toctree-l1.current a').text().indexOf("NAOqi ")==0){
        $(".naoqi").toggleClass('active');
    }

    //qibuild project
    if ($('.toctree-l1.current a').text().indexOf("Welcome to qiBuild documentation !")==0){
        $(".beginner").toggleClass('active');
    }
    else if ($('.toctree-l1.current a').text().indexOf("Advanced qibuild usage")==0){
        $(".advanced").toggleClass('active');
    }
    else if ($('.toctree-l1.current a').text().indexOf("Hacking qiBuild")==0){
        $(".hacking").toggleClass('active');
    }

    // add "On this page", add cssClasses
    if($('.yui-g .section h1').length > 0){
        $('.yui-g .section h1:first').addClass("titleWrapper");
        $('.yui-g .section h1:first').after($("#on-this-page").html())
    }
    else if($('.yui-g .section h2').length > 0){
        $('.yui-g .section h2:first').addClass("titleWrapper");
        $('.yui-g .section h2:first').after($("#on-this-page").html())
    }
    //remove first element on this page
    if($("#on-this-page").length > 0){
        var doms = $(".yui-g .section :first").nextUntil("#toc-list");
        doms = doms.add($("#toc-list"));
        doms.wrapAll('<div class="iNavWrapper"></div>');
        $("#toc-list ul li a:first").remove()
        $("#toc-list ul:first").replaceWith($("#toc-list ul li").html())
    }
    $("#toc-list").hide();
    $("#otp-link").click(function(){
        $("#toc-list").slideToggle();
        if($("h2#otp-link").hasClass("change-before")){
            $("h2#otp-link").removeClass("change-before")
        }
        else{
            $("h2#otp-link").addClass("change-before")
        }
    });

    if($("a.current.reference.internal").length>0){
        var left = $("a.current.reference.internal").position().left-1;
        var width = $("a.current.reference.internal").width();
        var offset = 51;
        var sidebarWidth = 339;
        var right = sidebarWidth - (left + width + offset);
        if($("a.current.reference.internal").height() <= 15){
            $("a.current.reference.internal").css("white-space","nowrap");
            $("a.current.reference.internal").css({"backgroundColor":"#0F2939","paddingTop":"2px", "paddingBottom":"2px","paddingLeft":left+"px","marginLeft":"-"+left+"px", "paddingRight":right+"px","marginRight":"-"+right+"px", "boxShadow":"0px 0px 1px rgb(15, 41, 57)"});
        }
        else{
            $("a.current.reference.internal").css({"float":"right","backgroundColor":"#0F2939","paddingTop":"2px", "paddingBottom":"2px","paddingLeft":left+"px","marginLeft":"-"+left+"px", "paddingRight":right+"px","marginRight":"-"+right+"px", "boxShadow":"0px 0px 1px rgb(15, 41, 57)"});
            left = $("a.current.reference.internal").position().left-1;
            width = $("a.current.reference.internal").width();
            right = sidebarWidth - (left + width + offset);
            $("a.current.reference.internal").css({"float":"right","backgroundColor":"#0F2939","paddingTop":"2px", "paddingBottom":"2px","paddingLeft":left+"px","marginLeft":"-"+left+"px", "paddingRight":right+"px","marginRight":"-"+right+"px", "boxShadow":"0px 0px 1px rgb(15, 41, 57)"});
        }
        $("a.current.reference.internal").parent().css("list-style-type","none");
    }

    //back to top
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700;
    //grab the "back to top" link
    var back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
        //back to top button
        ( $(this).scrollTop() > offset ) ? back_to_top.addClass('cd-is-visible') : back_to_top.removeClass('cd-is-visible cd-fade-out');
        if( $(this).scrollTop() > offset_opacity ) {
            back_to_top.addClass('cd-fade-out');
        }
    });

    //smooth scroll to top
    back_to_top.click(function(event){
        event.preventDefault();
        $('body,html').animate({
            scrollTop: 0 ,
        }, scroll_top_duration
        );
    });
    //add show source button

    //replace "go" with "search"
    $("#searchbox form input[type=submit]").val("Search")

    //trigger click on version triangle to jump to whats new
    $("#hd").click(function(e){if(e.pageX >= this.offsetWidth && e.pageY<120){$(".whatsnew")[0].click()}})
})

</script>


  </head>
  <body role="document">

    <div class="document">
  <div id="custom-doc" class="yui-t3">
    <div id="hd">
      
      <h1><a href="../../../index.html">SoftBank Robotics documentation</a>
      
      
      <span><a class="whatsnew" href="../../../news/index.html" >
      
          What's new in NAOqi 2.5?
      
      </a></span>
      
      </h1>
      <div id="global-nav">
        
        <a class="naoqi" title="NAOqi Developer guide" href="../../../index_dev_guide.html">NAOqi</a>
        <a class="pepper" title="Pepper documentation" href="../../../home_pepper.html">Pepper</a>
        <a class="nao" title="NAO documentation" href="../../../home_nao.html">NAO</a>
        <a class="romeo" title="Romeo Documentation" href="../../../home_romeo.html">Romeo</a>
        
        
        
        <div class="nav">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script></div>
      </div>

    </div>
    <main class="cd-container">
        <div id="bd">
          <div id="yui-main">
            <div class="yui-b">
              <div class="yui-g" id="dev-libqi-internal-messaging">
                
  <div class="section" id="messaging-system">
<span id="internal-messaging"></span><h1>Messaging system<a class="headerlink" href="#messaging-system" title="Permalink to this headline">Â¶</a></h1>
<p><em>DISCLAIMER</em> This document describes the messaging system. I don&#8217;t know all the
internals of that, so the knowledge described here is very sparse and maybe
inaccurate.</p>
<div class="section" id="high-level-view">
<h2>High-level view<a class="headerlink" href="#high-level-view" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="sessions">
<h3>Sessions<a class="headerlink" href="#sessions" title="Permalink to this headline">Â¶</a></h3>
<p>To use the messaging layer, you need a Session. Sessions are connected to each
other and make an undirected graph that we call a galaxy of sessions. On a
galaxy of sessions, there is a list of services and the service with id 1 is
the ServiceDirectory which contains that list.</p>
<p>The ServiceDirectory runs on a session which is the entry point for other
sessions to connect. When a session exposes a service, it listens on some other
port so that other sessions can connect to it when they need to contact the
service.</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><table border="1" class="docutils">
<colgroup>
</colgroup>
<tbody valign="top">
</tbody>
</table>
</div></blockquote>
<p>+&#8212;&#8212;&#8212;+  Service    |
|         |  Directory  |
|         +&#8212;&#8212;+&#8212;&#8212;+
|                |
|                |
|                |        +&#8212;&#8212;&#8212;&#8212;-+
|                |        |             |
|                +&#8212;&#8212;&#8211;+ SomeService |
|                |        |             |
|                |        +&#8212;&#8212;&#8212;&#8212;-+
|                |</p>
</div></blockquote>
<p>+&#8212;&#8212;-+&#8212;&#8212;+         |        +&#8212;&#8212;&#8212;&#8212;&#8211;+
|   Client     |         +&#8212;&#8212;&#8211;+ OtherService |
|   session    +&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+              |
+&#8212;&#8212;&#8212;&#8212;&#8211;+                  +&#8212;&#8212;&#8212;&#8212;&#8211;+</p>
</div></blockquote>
<p>There is no real difference between a client session and a service session. In
this diagram, it is just that the Client session does not expose any service,
but apart from that, it is a normal session. A session can call other services
whether it hosts services or not.</p>
</div>
<div class="section" id="address-system">
<h3>Address system<a class="headerlink" href="#address-system" title="Permalink to this headline">Â¶</a></h3>
<p>There is a three-part address system in qimessaging used to call functions,
trigger events, etc.</p>
<p>Services have a associated service ID. A service can give one or more objects
(by returning them). When a service gives an object, this object gets the same
service ID but a different object ID.</p>
<p>For example, the service directory is always service 1. If you have a service 2,
that service is addressed as 2.1. If that service gives you an object, that
object will have ID 2, which means its address is 2.2, the next will have ID 3.
The object ID 1 is always reserved for the service itself.</p>
<p>There is a third part on addresses which is the function ID. Every function,
event and property has an ID. User functions usually start at ID 100. IDs below
100 are hidden and reserved for qimessaging&#8217;s usage.</p>
</div>
<div class="section" id="exchanging-objects">
<h3>Exchanging objects<a class="headerlink" href="#exchanging-objects" title="Permalink to this headline">Â¶</a></h3>
<p>It is possible to exchange objects between a session and a service by returning
it from a function call or by giving it as an argument. When doing that, the
object will be wrapped by qimessaging objects.</p>
<p>You can see in the diagram below how an object is exposed from the server on the
right to the client on the left. Keep in mind that what I call client or server
in this section has no real importance as they can be swapped. You can pass
objects from service to client or from client to service and you will reach the
state described in this diagram.</p>
<blockquote>
<div><blockquote>
<div><p>Network</p>
<blockquote>
<div><ul class="simple">
<li></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div></blockquote>
</div></blockquote>
<p>+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+     |    +&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;+
|                  |     |    |                 |
|  RemoteObject    +&#8212;&#8212;&#8212;-+  BoundObject    |
|                  |     |    |                 |
+&#8212;&#8212;&#8212;^&#8212;&#8212;&#8211;+     |    +&#8212;&#8212;&#8211;+&#8212;&#8212;&#8211;+</p>
<blockquote>
<div><div class="line-block">
<div class="line">|             |</div>
<div class="line">|             |</div>
</div>
</div></blockquote>
<p>+&#8212;&#8212;&#8212;+&#8212;&#8212;&#8211;+     |    +&#8212;&#8212;&#8211;v&#8212;&#8212;&#8211;+
|                  |     |    |                 |
|   AnyObject      |     |    |   AnyObject     |
|                  |     |    |                 |
+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+     |    +&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;+</p>
<blockquote>
<div><div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<ul class="simple">
<li></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>When the object is exposed from the server, it will be wrapped in a BoundObject
that will own a reference to the AnyObject to keep it alive.</p>
<p>When the object is received by the client, you get an AnyObject which points to
a DynamicObject.</p>
<p>If the same object is returned twice for example, two BoundObjects will be
created and two RemoteObject will be created on the remote side. They will be
independent and have different addresses.</p>
</div>
<div class="section" id="lifetime">
<h3>Lifetime<a class="headerlink" href="#lifetime" title="Permalink to this headline">Â¶</a></h3>
<p>As said before, BoundObject owns a reference to the AnyObject so that the
RemoteObject can still contact it later.</p>
<p>There are three cases which causes that reference to be dropped:</p>
<ul class="simple">
<li>When the RemoteObject dies, it will call the hidden method <code class="docutils literal"><span class="pre">terminate()</span></code>
which will ultimately destroy the BoundObject and release the reference.</li>
<li>When the connection with the client is lost (legitimately or because of an
error), all BoundObjects exposed to it will be destroyed, releasing their
reference to the AnyObject.</li>
<li>When the service is unregistered, all addresses will become invalid, thus the
BoundObjects will also be destroyed, releasing their reference.</li>
</ul>
</div>
<div class="section" id="sending-an-object-through-a-remoteobject-or-boundobject">
<h3>Sending an object through a RemoteObject or BoundObject<a class="headerlink" href="#sending-an-object-through-a-remoteobject-or-boundobject" title="Permalink to this headline">Â¶</a></h3>
<p><code class="xref cpp cpp-guess docutils literal"><span class="pre">RemoteObject</span></code> and <code class="xref cpp cpp-guess docutils literal"><span class="pre">BoundObject</span></code> both inherit from <code class="xref cpp cpp-guess docutils literal"><span class="pre">ObjectHost</span></code> which is a class
that has a list of <code class="xref cpp cpp-guess docutils literal"><span class="pre">BoundObject</span></code>. They both inherit from it because you also
need the <code class="xref cpp cpp-guess docutils literal"><span class="pre">RemoteObject</span></code> to hold <code class="xref cpp cpp-guess docutils literal"><span class="pre">BoundObject</span></code>-s when sending an object as an
argument.</p>
<p>Since a <code class="xref cpp cpp-guess docutils literal"><span class="pre">RemoteObject</span></code> does not have an ID to refer to (it is not a service),
when sending an object through it, it must create an address. The service ID of
the address it forges is the one of the service it sends the object to. To avoid
having two objects with the same IDs on the service, it starts counting object
IDs from 2^31.</p>
<p>I don&#8217;t know what happens when object IDs overflow, probably bad things that
they only talk about in books.</p>
</div>
</div>
<div class="section" id="lower-level-view">
<h2>Lower-level view<a class="headerlink" href="#lower-level-view" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="messages">
<h3>Messages<a class="headerlink" href="#messages" title="Permalink to this headline">Â¶</a></h3>
<p>In the end, qimessaging all comes down to the exchange of <code class="xref cpp cpp-guess docutils literal"><span class="pre">qi::Message</span></code>. A
message is a structure with different fields:</p>
<ul class="simple">
<li>a magic number to identify qimessaging packets</li>
<li>an ID and a type which will be detailed later</li>
<li>a destination address with Service.Object.Function</li>
<li>a variable-size signature to describe the payload of the message</li>
<li>a buffer which contains the payload</li>
</ul>
<p>The last two parts are the only variable part of the message, the rest is part
of the fixed-size header.</p>
</div>
<div class="section" id="messages-types-and-ids">
<h3>Messages types and IDs<a class="headerlink" href="#messages-types-and-ids" title="Permalink to this headline">Â¶</a></h3>
<p>Messages have different types described in <strong>message.hpp</strong>. Message IDs are
always incremented when sending a new request, for example a call (and maybe
other types).</p>
<p>Then the response to that call may be Reply, Error or Canceled. In whichever
case, the response will have the same ID as the Call message to associate them
together.</p>
</div>
<div class="section" id="exchanging-messages">
<h3>Exchanging messages<a class="headerlink" href="#exchanging-messages" title="Permalink to this headline">Â¶</a></h3>
<p>At the lowest level, we use Boost.Asio to handle the TCP sockets. This is
wrapped in the class <code class="xref cpp cpp-guess docutils literal"><span class="pre">TcpTransportSocket</span></code> which inherits from the virtual class
<code class="xref cpp cpp-guess docutils literal"><span class="pre">TransportSocket</span></code>. It is possible to implement the messaging over something else
by specializing that class, for example to use UNIX sockets, pipes on the file
system (why not!), etc.</p>
<p>I don&#8217;t know the exact path of messages through the classes, but for a call,
first there is a <code class="docutils literal"><span class="pre">messageReady</span></code> signal triggered in <code class="xref cpp cpp-guess docutils literal"><span class="pre">TransportSocket</span></code>. There
is a class that receives that signal (probably <code class="xref cpp cpp-guess docutils literal"><span class="pre">Server</span></code>) and forwards it to the
concerned object by calling its <code class="docutils literal"><span class="pre">onMessage</span></code> method. Then the object can handle
the call and reply later by doing a send on the socket.</p>
<p>If the message is a Reply, I think the <code class="xref cpp cpp-guess docutils literal"><span class="pre">RemoteObject</span></code> is directly connected to
the <code class="xref cpp cpp-guess docutils literal"><span class="pre">TransportSocket</span></code> and handles the messages. There is a <code class="xref cpp cpp-guess docutils literal"><span class="pre">MessageDispatcher</span></code>
class somewhere that probably does something.</p>
</div>
</div>
<div class="section" id="middle-level-view-serialization">
<h2>Middle-level view (serialization)<a class="headerlink" href="#middle-level-view-serialization" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="streamcontext">
<h3>StreamContext<a class="headerlink" href="#streamcontext" title="Permalink to this headline">Â¶</a></h3>
<p><code class="xref cpp cpp-guess docutils literal"><span class="pre">TcpTransportSocket</span></code> inherits from <code class="xref cpp cpp-guess docutils literal"><span class="pre">StreamContext</span></code> which, as the name suggests,
is a context associated to a stream. It is used to hold various information to
know how to serialize things.</p>
<p>For example, when sending an object, we send the whole <a class="reference internal" href="../api/cpp/type/metaobject.html#qi::MetaObject" title="qi::MetaObject"><code class="xref cpp cpp-guess docutils literal"><span class="pre">MetaObject</span></code></a> with it. But
when getting a service twice, the <a class="reference internal" href="../api/cpp/type/metaobject.html#qi::MetaObject" title="qi::MetaObject"><code class="xref cpp cpp-guess docutils literal"><span class="pre">MetaObject</span></code></a> (which is a heavy structure) is
still the same and there is no need to send it again. For that, there is a
<a class="reference internal" href="../api/cpp/type/metaobject.html#qi::MetaObject" title="qi::MetaObject"><code class="xref cpp cpp-guess docutils literal"><span class="pre">MetaObject</span></code></a> cache system and we keep a bit of information in the
<code class="xref cpp cpp-guess docutils literal"><span class="pre">StreamContext</span></code> which is &#8220;Have we already sent this <a class="reference internal" href="../api/cpp/type/metaobject.html#qi::MetaObject" title="qi::MetaObject"><code class="xref cpp cpp-guess docutils literal"><span class="pre">MetaObject</span></code></a> on this
stream?&#8221;. That way we avoid sending it twice, and the remote side does not
expect to receive it a second time.</p>
<p>The other thing it is used for is capabilities. Capabilities are there to
support protocol evolutions. For example, when the <a class="reference internal" href="../api/cpp/type/metaobject.html#qi::MetaObject" title="qi::MetaObject"><code class="xref cpp cpp-guess docutils literal"><span class="pre">MetaObject</span></code></a> cache system was
added, a new capability was added so that we can identify processes using the
old protocol and not use that system with them. These capabilities are
associated with a remote host, so they are stored in the <code class="xref cpp cpp-guess docutils literal"><span class="pre">StreamContext</span></code>.</p>
</div>
<div class="section" id="serializing">
<h3>Serializing<a class="headerlink" href="#serializing" title="Permalink to this headline">Â¶</a></h3>
<p>Serialization is done by the class <code class="xref cpp cpp-guess docutils literal"><span class="pre">BinaryEncoder</span></code> in <strong>binarycodec.cpp</strong>. That
class is a visitor that has access to the <code class="xref cpp cpp-guess docutils literal"><span class="pre">StreamContext</span></code> and visits the type to
serialize. It fills-in a buffer with its associated signature so that they can
be sent in the <code class="xref cpp cpp-guess docutils literal"><span class="pre">Message</span></code>.</p>
</div>
<div class="section" id="deserializing">
<h3>Deserializing<a class="headerlink" href="#deserializing" title="Permalink to this headline">Â¶</a></h3>
<p>Deserialization is a done in a very similar way. When a message is received, the
associated signature is used to instantiate an empty <a class="reference internal" href="../api/cpp/type/anyvalue.html#qi::AnyValue" title="qi::AnyValue"><code class="xref cpp cpp-guess docutils literal"><span class="pre">AnyValue</span></code></a> with the type
interfaces corresponding to it. This is done in <code class="xref cpp cpp-guess docutils literal"><span class="pre">Message::value</span></code>.</p>
<p>Then the <code class="xref cpp cpp-guess docutils literal"><span class="pre">BinaryDecoder</span></code> visitor visits this empty value and fills it in with
the data from the buffer.</p>
</div>
<div class="section" id="what-has-gone-bad-and-why-shared-memory-is-half-broken">
<h3>What has gone bad (and why shared memory is half broken)?<a class="headerlink" href="#what-has-gone-bad-and-why-shared-memory-is-half-broken" title="Permalink to this headline">Â¶</a></h3>
<p>This technique is not the best one (IMHO). Values are default initialized and
then updated, and this pattern seems broken to me.</p>
<p>When implementing shared memory, we did not change the signature protocol and we
handle shared buffers the same way as normal buffers in signatures. When
deserializing, because of that, we need to change the type of the <a class="reference internal" href="../api/cpp/type/anyvalue.html#qi::AnyValue" title="qi::AnyValue"><code class="xref cpp cpp-guess docutils literal"><span class="pre">AnyValue</span></code></a>
while we read the message buffer. It is only at that moment that we know that
the message does not contain the buffer but only shared memory coordinates and
that we must use the shared memory type interface for the <a class="reference internal" href="../api/cpp/type/anyvalue.html#qi::AnyValue" title="qi::AnyValue"><code class="xref cpp cpp-guess docutils literal"><span class="pre">AnyValue</span></code></a>.</p>
<p>As it is implemented right now, the function deserialize updates the
AnyReference and replaces the type of it.</p>
<p>There is a problem with that when the shared buffer is part of a tuple
(<code class="xref cpp cpp-guess docutils literal"><span class="pre">StructTypeInterface</span></code>) which has a static list of subtypes. This type interface
is instantiated from the signature of the message, and thus with a normal
BufferTypeInterface. When we reach that part when we need to instantiate the
shared buffer type interface, it is too late to replace the one in the structure
which was created at the beginning of the deserialization.</p>
<p>My solution to this, that I find more elegant and that solves the problem, is to
rewrite that part and instantiate the whole tree only once with the correct
values (not default initializing and then assigning). This implies writing
another visitor to visit the signature directly and not reusing the one on
<a class="reference internal" href="../api/cpp/type/anyvalue.html#qi::AnyValue" title="qi::AnyValue"><code class="xref cpp cpp-guess docutils literal"><span class="pre">AnyValue</span></code></a>. The system would instantiate the type interfaces from the bottom-up.</p>
</div>
</div>
</div>


              </div>
            </div>
          </div>
          
            
              <div class="yui-b" id="sidebar">
                
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contents.html">Site map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../news/index.html">Whatâs new</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index_dev_guide.html">NAOqi - Developer guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/creating_applications/index.html">Creating an application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ref/life/index.html">Programming for a living robot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/index_tuto.html">Other tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../software/choregraphe/index.html">Choregraphe Suite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../programming_index.html">SDKs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../naoqi/index.html">NAOqi APIs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">qi Framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../api/index.html">API References</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guide/index.html">Hands-on Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../design/index.html">Design Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="typesystem.html">Type system</a></li>
<li class="toctree-l3"><a class="reference internal" href="object.html">Object type erasure</a></li>
<li class="toctree-l3"><a class="reference internal" href="template.html">Registering template types</a></li>
<li class="toctree-l3"><a class="reference internal" href="call.html">Call code path</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Messaging system</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../changelog/index.html">qi Framework - ChangeLog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelog/interface.html">qi Framework - Deprecation history</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ref/index.html">Former NAOqi Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../simulators/simulator_index.html">Simulators</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../home_nao.html"><strong>NAO</strong> - Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../home_pepper.html"><strong>Pepper</strong> - Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../home_romeo.html"><strong>Romeo</strong> - Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../legal/notice.html">Legal notices</a></li>
</ul>

    <div id="on-this-page" style="display:none;">
        <h2 id="otp-link">On this page</h2>
        <div id="toc-list">
            <ul>
<li><a class="reference internal" href="#">Messaging system</a><ul>
<li><a class="reference internal" href="#high-level-view">High-level view</a><ul>
<li><a class="reference internal" href="#sessions">Sessions</a></li>
<li><a class="reference internal" href="#address-system">Address system</a></li>
<li><a class="reference internal" href="#exchanging-objects">Exchanging objects</a></li>
<li><a class="reference internal" href="#lifetime">Lifetime</a></li>
<li><a class="reference internal" href="#sending-an-object-through-a-remoteobject-or-boundobject">Sending an object through a RemoteObject or BoundObject</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lower-level-view">Lower-level view</a><ul>
<li><a class="reference internal" href="#messages">Messages</a></li>
<li><a class="reference internal" href="#messages-types-and-ids">Messages types and IDs</a></li>
<li><a class="reference internal" href="#exchanging-messages">Exchanging messages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#middle-level-view-serialization">Middle-level view (serialization)</a><ul>
<li><a class="reference internal" href="#streamcontext">StreamContext</a></li>
<li><a class="reference internal" href="#serializing">Serializing</a></li>
<li><a class="reference internal" href="#deserializing">Deserializing</a></li>
<li><a class="reference internal" href="#what-has-gone-bad-and-why-shared-memory-is-half-broken">What has gone bad (and why shared memory is half broken)?</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
    </div>
        </div>
      </div>
              </div>
            
          
        </div>
    </main>
    <a href="#0" class="cd-top"></a>
    <div id="ft">
      
      <a title="Glossary" href="../../../glossary.html">Glossary</a>
      <a title="Site map" href="../../../contents.html">Site map</a>
      <a title="Index" href="../../../genindex.html">Index</a>
      <a title="Support" target="_blank" href="https://account.aldebaran.com/support/">Support</a>
      <a title="Contact" target="_blank" href="https://www.aldebaran.com/en/contact">Contact</a>
      <a title="Legal Notices" href="../../../legal/notice.html">Legal Notices</a>
      
      
      <img src="https://www.ald.softbankrobotics.com/sites/aldebaran/files/logos-picture/2016_digital_logo_sbr_112x31_0.png" alt="">
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>